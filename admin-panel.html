<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - QBCI‚Ñ¢ Analytics | Avantus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #000000;
            --secondary-bg: #0a0a0a;
            --card-bg: #1a1a1a;
            --accent: #ffffff;
            --accent-secondary: #888888;
            --accent-glow: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .top-nav {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-brand h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, #0099cc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-badge {
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent);
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--accent);
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .user-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .user-email {
            color: var(--accent);
            font-weight: 600;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, var(--accent) 0%, #0099cc 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--accent-glow);
        }

        .btn-secondary {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-header h2 {
            color: var(--accent);
            font-size: 1.3rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        select {
            width: 100%;
            padding: 0.75rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        thead {
            background: var(--secondary-bg);
        }

        th {
            padding: 1rem;
            text-align: left;
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        tbody tr:hover {
            background: var(--secondary-bg);
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: var(--accent);
            background: rgba(0, 212, 255, 0.05);
        }

        .file-upload-area.dragover {
            border-color: var(--accent);
            background: rgba(0, 212, 255, 0.1);
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .alert-info {
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            color: var(--accent);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .close-btn:hover {
            color: var(--danger);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .top-nav {
                flex-direction: column;
                gap: 1rem;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <nav class="top-nav">
        <div class="nav-brand">
            <h1>QBCI‚Ñ¢ Admin</h1>
            <span class="admin-badge">Admin Panel</span>
        </div>
        <div class="nav-actions">
            <span class="user-info">Logged in as: <span class="user-email" id="userEmail">Loading...</span></span>
            <button class="btn btn-secondary btn-small" onclick="window.location.href='ci-calculator.html'">View Calculator</button>
            <button class="btn btn-danger btn-small" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Games</div>
                <div class="stat-value" id="totalGames">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Unique Players</div>
                <div class="stat-value" id="totalPlayers">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Database Status</div>
                <div class="stat-value" style="font-size: 1.5rem;" id="dbStatus">üü¢ Connected</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('data-management')">Data Management</button>
            <button class="tab" onclick="switchTab('bulk-upload')">Bulk Upload</button>
            <button class="tab" onclick="switchTab('ocr-upload')">üì∏ OCR Upload</button>
            <button class="tab" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- Data Management Tab -->
        <div id="data-management" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2>QB Game Data</h2>
                    <button class="btn btn-success btn-small" onclick="openAddModal()">+ Add New Game</button>
                </div>

                <div id="alertBox" class="alert"></div>

                <div class="input-group">
                    <label>Filter by Player</label>
                    <select id="playerFilter" onchange="loadData()">
                        <option value="">All Players</option>
                    </select>
                </div>

                <div id="dataTable">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>Loading data...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Upload Tab -->
        <div id="bulk-upload" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Bulk CSV Upload</h2>
                </div>

                <div id="uploadAlertBox" class="alert"></div>

                <div class="file-upload-area" id="dropArea">
                    <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
                    <h3>Drop CSV file here or click to browse</h3>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                        Expected format: player, week, opponent, passing_yards, accuracy_pct, comp_pct, btt_rate, twp_rate, prop_line (optional), bet_result (optional)
                    </p>
                    <button class="btn" style="margin-top: 1rem;" onclick="document.getElementById('csvFile').click()">Select File</button>
                </div>

                <div id="uploadPreview" style="display: none; margin-top: 2rem;">
                    <h3 style="color: var(--accent); margin-bottom: 1rem;">Preview</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        <span id="previewCount">0</span> records ready to upload
                    </p>
                    <button class="btn btn-success" onclick="uploadCSVData()">Upload to Database</button>
                    <button class="btn btn-secondary" onclick="cancelUpload()" style="margin-left: 1rem;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- OCR Upload Tab -->
        <div id="ocr-upload" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>OCR Screenshot Upload</h2>
                </div>

                <div id="ocrAlertBox" class="alert"></div>

                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    Upload a screenshot of a QB stats table and use OCR to automatically extract the data. Perfect for quickly adding data from images!
                </p>

                <div class="form-grid" style="margin-bottom: 2rem;">
                    <div class="input-group">
                        <label>OCR Language</label>
                        <select id="ocrLang">
                            <option value="eng">English</option>
                            <option value="spa">Spanish</option>
                            <option value="fra">French</option>
                            <option value="deu">German</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Table has header row</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                            <input type="checkbox" id="ocrHasHeader" checked style="width: auto;">
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Check if first row contains column names</span>
                        </div>
                    </div>
                </div>

                <!-- Image Upload Area -->
                <div class="file-upload-area" id="ocrDropArea" style="margin-bottom: 2rem;">
                    <input type="file" id="ocrImageFile" accept="image/*" style="display: none;" onchange="handleOcrImageSelect(event)">
                    <div id="ocrImagePreview" style="display: none;">
                        <img id="ocrPreviewImg" src="" alt="preview" style="max-width: 100%; max-height: 400px; border-radius: 8px;">
                    </div>
                    <div id="ocrPlaceholder">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì∏</div>
                        <h3>Drop screenshot here or click to browse</h3>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                            Upload an image of a QB stats table (PNG, JPG, etc.)
                        </p>
                        <button class="btn" style="margin-top: 1rem;" onclick="document.getElementById('ocrImageFile').click()">Select Image</button>
                    </div>
                </div>

                <!-- OCR Controls -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <button class="btn btn-success" id="runOcrBtn" onclick="runOCR()" disabled>
                        üîç Run OCR
                    </button>
                    <button class="btn btn-secondary" id="parseOcrBtn" onclick="parseOcrText()" disabled>
                        üìä Parse to Table
                    </button>
                </div>

                <!-- OCR Progress -->
                <div id="ocrProgressContainer" style="display: none; margin-bottom: 2rem;">
                    <label>OCR Progress</label>
                    <div style="background: var(--secondary-bg); border-radius: 8px; height: 24px; overflow: hidden; margin-top: 0.5rem;">
                        <div id="ocrProgressBar" style="background: linear-gradient(135deg, var(--accent) 0%, #0099cc 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="ocrProgressText" style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.9rem;">Starting OCR...</p>
                </div>

                <!-- OCR Text Output -->
                <div id="ocrTextContainer" style="display: none; margin-bottom: 2rem;">
                    <label>Recognized Text (editable)</label>
                    <textarea id="ocrText" style="width: 100%; min-height: 200px; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; color: var(--text-primary); font-family: monospace; font-size: 0.9rem;" placeholder="OCR output will appear here..."></textarea>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;">
                        Detected delimiter: <strong id="detectedDelimiter">Auto-detecting...</strong>
                    </p>
                </div>

                <!-- Parsed Table Preview -->
                <div id="ocrTableContainer" style="display: none;">
                    <h3 style="color: var(--accent); margin-bottom: 1rem;">Parsed Table Preview</h3>

                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <button class="btn btn-small btn-secondary" onclick="ocrAddRow()">+ Add Row</button>
                        <button class="btn btn-small btn-secondary" onclick="ocrAddColumn()">+ Add Column</button>
                        <button class="btn btn-small btn-success" onclick="uploadOcrDataToSupabase()">‚úÖ Upload to Database</button>
                        <button class="btn btn-small btn-secondary" onclick="downloadOcrCSV()">üíæ Download CSV</button>
                    </div>

                    <div style="overflow-x: auto; border: 1px solid var(--border); border-radius: 8px;">
                        <table id="ocrTable" style="width: 100%; border-collapse: collapse;">
                            <thead id="ocrTableHead"></thead>
                            <tbody id="ocrTableBody"></tbody>
                        </table>
                    </div>

                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 1rem;">
                        üí° Tip: Edit cells directly, add/remove rows and columns, then upload to your database or download as CSV.
                    </p>
                </div>
            </div>

            <!-- Tips Card -->
            <div class="card">
                <div class="card-header">
                    <h2>OCR Tips for Best Results</h2>
                </div>
                <div style="color: var(--text-secondary); line-height: 1.8;">
                    <ul style="padding-left: 1.5rem;">
                        <li>Use high-resolution screenshots with good contrast</li>
                        <li>Crop the image to show only the table (remove headers/footers)</li>
                        <li>Ensure text is clearly readable and not blurry</li>
                        <li>Tables with clear column separators (pipes |, tabs, or multiple spaces) work best</li>
                        <li>After OCR, verify the data before uploading to the database</li>
                        <li>You can manually edit both the text and the parsed table before uploading</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Account Settings</h2>
                </div>

                <div id="settingsAlertBox" class="alert"></div>

                <div class="input-group">
                    <label>Email Address</label>
                    <input type="email" id="settingsEmail" readonly style="background: var(--primary-bg);">
                </div>

                <div class="input-group">
                    <label>User ID</label>
                    <input type="text" id="userId" readonly style="background: var(--primary-bg);">
                </div>

                <div class="input-group">
                    <label>Account Created</label>
                    <input type="text" id="createdAt" readonly style="background: var(--primary-bg);">
                </div>

                <hr style="border: none; border-top: 1px solid var(--border); margin: 2rem 0;">

                <h3 style="color: var(--accent); margin-bottom: 1rem;">Danger Zone</h3>

                <button class="btn btn-danger" onclick="confirmClearData()">Clear All Data</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="gameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Game</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <form id="gameForm" onsubmit="saveGame(event)">
                <input type="hidden" id="gameId">

                <div class="input-group">
                    <label>Player Name *</label>
                    <input type="text" id="player" required>
                </div>

                <div class="form-grid">
                    <div class="input-group">
                        <label>Week *</label>
                        <input type="number" id="week" min="1" max="18" required>
                    </div>

                    <div class="input-group">
                        <label>Opponent *</label>
                        <input type="text" id="opponent" required>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="input-group">
                        <label>Passing Yards *</label>
                        <input type="number" id="passing_yards" step="1" required>
                    </div>

                    <div class="input-group">
                        <label>Accuracy % *</label>
                        <input type="number" id="accuracy_pct" step="0.1" required>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="input-group">
                        <label>Completion % *</label>
                        <input type="number" id="comp_pct" step="0.1" required>
                    </div>

                    <div class="input-group">
                        <label>BTT Rate %</label>
                        <input type="number" id="btt_rate" step="0.1" value="0">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="input-group">
                        <label>TWP Rate %</label>
                        <input type="number" id="twp_rate" step="0.1" value="0">
                    </div>

                    <div class="input-group">
                        <label>Prop Line</label>
                        <input type="number" id="prop_line" step="0.5">
                    </div>
                </div>

                <div class="input-group">
                    <label>Bet Result</label>
                    <select id="bet_result">
                        <option value="">Not Set</option>
                        <option value="Over">Over</option>
                        <option value="Under">Under</option>
                    </select>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-success">Save Game</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config/supabase-config.js"></script>

    <script>
        let client = null;
        let currentUser = null;
        let csvDataToUpload = null;

        // Initialize
        async function init() {
            client = initSupabase();

            if (!client) {
                showAlert('Supabase not configured', 'error');
                return;
            }

            // Check auth
            const { session, error } = await SupabaseAuth.getSession();

            if (error || !session) {
                window.location.href = 'admin-login.html';
                return;
            }

            currentUser = session.user;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('settingsEmail').value = currentUser.email;
            document.getElementById('userId').value = currentUser.id;
            document.getElementById('createdAt').value = new Date(currentUser.created_at).toLocaleString();

            // Load data
            await loadData();
            await loadPlayers();
        }

        async function loadData() {
            const playerFilter = document.getElementById('playerFilter').value;
            const { data, error } = await SupabaseDB.getQBData(playerFilter || null);

            if (error) {
                showAlert('Error loading data: ' + error.message, 'error');
                return;
            }

            // Update stats
            document.getElementById('totalGames').textContent = data.length;
            const uniquePlayers = [...new Set(data.map(g => g.player))];
            document.getElementById('totalPlayers').textContent = uniquePlayers.length;

            // Render table
            if (data.length === 0) {
                document.getElementById('dataTable').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No data found. Add some games to get started!</p>
                    </div>
                `;
            } else {
                renderDataTable(data);
            }
        }

        function renderDataTable(data) {
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Week</th>
                            <th>Opponent</th>
                            <th>Yards</th>
                            <th>Accuracy</th>
                            <th>Comp %</th>
                            <th>Prop Line</th>
                            <th>Result</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(game => `
                            <tr>
                                <td>${game.player}</td>
                                <td>${game.week}</td>
                                <td>${game.opponent}</td>
                                <td>${game.passing_yards}</td>
                                <td>${game.accuracy_pct}%</td>
                                <td>${game.comp_pct}%</td>
                                <td>${game.prop_line || 'N/A'}</td>
                                <td>${game.bet_result || 'N/A'}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-small btn-secondary" onclick='editGame(${JSON.stringify(game)})'>Edit</button>
                                        <button class="btn btn-small btn-danger" onclick="deleteGame('${game.id}')">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('dataTable').innerHTML = table;
        }

        async function loadPlayers() {
            const { data } = await SupabaseDB.getPlayers();
            const select = document.getElementById('playerFilter');

            data.forEach(player => {
                const option = document.createElement('option');
                option.value = player;
                option.textContent = player;
                select.appendChild(option);
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add New Game';
            document.getElementById('gameForm').reset();
            document.getElementById('gameId').value = '';
            document.getElementById('gameModal').classList.add('show');
        }

        function editGame(game) {
            document.getElementById('modalTitle').textContent = 'Edit Game';
            document.getElementById('gameId').value = game.id;
            document.getElementById('player').value = game.player;
            document.getElementById('week').value = game.week;
            document.getElementById('opponent').value = game.opponent;
            document.getElementById('passing_yards').value = game.passing_yards;
            document.getElementById('accuracy_pct').value = game.accuracy_pct;
            document.getElementById('comp_pct').value = game.comp_pct;
            document.getElementById('btt_rate').value = game.btt_rate || 0;
            document.getElementById('twp_rate').value = game.twp_rate || 0;
            document.getElementById('prop_line').value = game.prop_line || '';
            document.getElementById('bet_result').value = game.bet_result || '';
            document.getElementById('gameModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('gameModal').classList.remove('show');
        }

        async function saveGame(event) {
            event.preventDefault();

            const gameData = {
                player: document.getElementById('player').value,
                week: parseInt(document.getElementById('week').value),
                opponent: document.getElementById('opponent').value,
                passing_yards: parseInt(document.getElementById('passing_yards').value),
                accuracy_pct: parseFloat(document.getElementById('accuracy_pct').value),
                comp_pct: parseFloat(document.getElementById('comp_pct').value),
                btt_rate: parseFloat(document.getElementById('btt_rate').value),
                twp_rate: parseFloat(document.getElementById('twp_rate').value),
                prop_line: document.getElementById('prop_line').value ? parseFloat(document.getElementById('prop_line').value) : null,
                bet_result: document.getElementById('bet_result').value || null
            };

            const gameId = document.getElementById('gameId').value;

            let result;
            if (gameId) {
                result = await SupabaseDB.updateQBData(gameId, gameData);
            } else {
                result = await SupabaseDB.insertQBData(gameData);
            }

            if (result.error) {
                showAlert('Error saving game: ' + result.error.message, 'error');
                return;
            }

            showAlert(gameId ? 'Game updated successfully!' : 'Game added successfully!', 'success');
            closeModal();
            await loadData();
        }

        async function deleteGame(id) {
            if (!confirm('Are you sure you want to delete this game?')) return;

            const { error } = await SupabaseDB.deleteQBData(id);

            if (error) {
                showAlert('Error deleting game: ' + error.message, 'error');
                return;
            }

            showAlert('Game deleted successfully!', 'success');
            await loadData();
        }

        // CSV Upload
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSVForUpload(e.target.result);
            };
            reader.readAsText(file);
        }

        function parseCSVForUpload(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            csvDataToUpload = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                csvDataToUpload.push(row);
            }

            document.getElementById('previewCount').textContent = csvDataToUpload.length;
            document.getElementById('uploadPreview').style.display = 'block';
            showUploadAlert(`Parsed ${csvDataToUpload.length} records successfully!`, 'success');
        }

        async function uploadCSVData() {
            if (!csvDataToUpload) return;

            // Convert to proper format
            const formattedData = csvDataToUpload.map(row => ({
                player: row.player,
                week: parseInt(row.week),
                opponent: row.opponent,
                passing_yards: parseInt(row.passing_yards),
                accuracy_pct: parseFloat(row.accuracy_pct),
                comp_pct: parseFloat(row.comp_pct),
                btt_rate: parseFloat(row.btt_rate || 0),
                twp_rate: parseFloat(row.twp_rate || 0),
                prop_line: row.prop_line ? parseFloat(row.prop_line) : null,
                bet_result: row.bet_result || null
            }));

            const { error } = await SupabaseDB.bulkInsertCSV(formattedData);

            if (error) {
                showUploadAlert('Error uploading data: ' + error.message, 'error');
                return;
            }

            showUploadAlert(`Successfully uploaded ${formattedData.length} records!`, 'success');
            cancelUpload();
            await loadData();
            switchTab('data-management');
        }

        function cancelUpload() {
            csvDataToUpload = null;
            document.getElementById('csvFile').value = '';
            document.getElementById('uploadPreview').style.display = 'none';
        }

        async function confirmClearData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL data from the database. This action cannot be undone. Are you sure?')) return;
            if (!confirm('Last chance! Really delete everything?')) return;

            // This would require admin privileges - implement based on your needs
            showSettingsAlert('Feature requires additional permissions', 'info');
        }

        async function logout() {
            await SupabaseAuth.signOut();
            window.location.href = 'admin-login.html';
        }

        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => alertBox.className = 'alert', 5000);
        }

        function showUploadAlert(message, type) {
            const alertBox = document.getElementById('uploadAlertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => alertBox.className = 'alert', 5000);
        }

        function showSettingsAlert(message, type) {
            const alertBox = document.getElementById('settingsAlertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => alertBox.className = 'alert', 5000);
        }

        // Drag and drop
        const dropArea = document.getElementById('dropArea');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
        });

        dropArea.addEventListener('drop', function(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('csvFile').files = files;
                handleFileSelect({ target: { files } });
            }
        });

        // ============================================================
        // OCR FUNCTIONALITY
        // ============================================================

        let ocrImageUrl = null;
        let ocrWorker = null;
        let ocrTableData = [];

        // CSV helper functions
        function csvEscape(value) {
            if (value == null) return '';
            const s = String(value);
            const mustQuote = s.includes(',') || s.includes('\n') || s.includes('"');
            const escaped = s.replaceAll('"', '""');
            return mustQuote ? `"${escaped}"` : escaped;
        }

        function rowsToCSV(rows) {
            return rows.map(r => r.map(csvEscape).join(',')).join('\n');
        }

        // Text parsing helpers
        function smartSplitLines(text) {
            const rawLines = text.replace(/\r/g, '').split('\n')
                .map(l => l.replace(/[\u200B\u200C\u200D\uFEFF]/g, '').trim());
            return rawLines.filter(l => l.length > 0);
        }

        function guessDelimiter(lines) {
            const delimiters = [
                { label: 'Tabs', rx: /\t+/g },
                { label: 'Pipes |', rx: /\s*\|\s*/g },
                { label: 'Semicolons ;', rx: /\s*;\s*/g },
                { label: 'Multiple spaces', rx: /\s{2,}/g },
            ];

            let best = { score: -Infinity, rx: /\s{2,}/g, label: 'Multiple spaces' };

            for (const d of delimiters) {
                const counts = lines.slice(0, 30).map(l => l.split(d.rx).length);
                if (counts.length === 0) continue;

                const sorted = counts.slice().sort((a, b) => a - b);
                const mode = sorted[Math.floor(counts.length / 2)];
                const variance = counts.reduce((acc, c) => acc + Math.abs(c - mode), 0);
                const score = (mode || 0) * 10 - variance;

                if (score > best.score) {
                    best = { score, rx: d.rx, label: d.label };
                }
            }

            return best;
        }

        function parseTable(text) {
            const lines = smartSplitLines(text);
            const delimiter = guessDelimiter(lines);

            let rows = lines.map(l => l.split(delimiter.rx).map(c => c.trim()));

            // Find most common column count
            const colCounts = rows.map(r => r.length);
            const freq = new Map();
            for (const n of colCounts) {
                freq.set(n, (freq.get(n) || 0) + 1);
            }
            const modeCols = [...freq.entries()].sort((a, b) => b[1] - a[1])[0]?.[0] ?? 1;

            // Normalize rows to have same column count
            rows = rows
                .filter(r => r.length >= Math.max(1, Math.floor(modeCols * 0.6)))
                .map(r => {
                    if (r.length < modeCols) {
                        return [...r, ...Array(modeCols - r.length).fill('')];
                    }
                    if (r.length > modeCols) {
                        return r.slice(0, modeCols);
                    }
                    return r;
                });

            return { rows, modeCols, delimiter: delimiter.label };
        }

        // Handle image selection
        function handleOcrImageSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const file = files[0];
            if (ocrImageUrl) URL.revokeObjectURL(ocrImageUrl);

            ocrImageUrl = URL.createObjectURL(file);

            // Show preview
            document.getElementById('ocrPreviewImg').src = ocrImageUrl;
            document.getElementById('ocrImagePreview').style.display = 'block';
            document.getElementById('ocrPlaceholder').style.display = 'none';
            document.getElementById('runOcrBtn').disabled = false;

            // Reset outputs
            document.getElementById('ocrTextContainer').style.display = 'none';
            document.getElementById('ocrTableContainer').style.display = 'none';
            document.getElementById('ocrText').value = '';
            ocrTableData = [];
        }

        // Drag and drop for OCR
        const ocrDropArea = document.getElementById('ocrDropArea');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            ocrDropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            ocrDropArea.addEventListener(eventName, () => {
                ocrDropArea.classList.add('dragover');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            ocrDropArea.addEventListener(eventName, () => {
                ocrDropArea.classList.remove('dragover');
            }, false);
        });

        ocrDropArea.addEventListener('drop', function(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('ocrImageFile').files = files;
                handleOcrImageSelect({ target: { files } });
            }
        });

        // Convert image to base64
        async function imageToBase64(imageUrl) {
            return new Promise((resolve, reject) => {
                fetch(imageUrl)
                    .then(res => res.blob())
                    .then(blob => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const base64 = reader.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    })
                    .catch(reject);
            });
        }

        // Run OCR with Claude API
        async function runOCR() {
            if (!ocrImageUrl) return;

            // Check if Claude API is configured
            if (typeof CLAUDE_CONFIG === 'undefined' || !CLAUDE_CONFIG.apiKey || CLAUDE_CONFIG.apiKey === 'YOUR_CLAUDE_API_KEY') {
                showOcrAlert('Claude API key not configured. Please add your API key to config/supabase-config.js', 'error');
                return;
            }

            // Show progress
            document.getElementById('ocrProgressContainer').style.display = 'block';
            document.getElementById('ocrProgressBar').style.width = '10%';
            document.getElementById('ocrProgressText').textContent = 'Converting image...';
            document.getElementById('runOcrBtn').disabled = true;

            try {
                // Convert image to base64
                const base64Image = await imageToBase64(ocrImageUrl);

                document.getElementById('ocrProgressBar').style.width = '30%';
                document.getElementById('ocrProgressText').textContent = 'Analyzing image with Claude...';

                // Call Claude API
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': CLAUDE_CONFIG.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: CLAUDE_CONFIG.model,
                        max_tokens: 4096,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: 'image/jpeg',
                                        data: base64Image
                                    }
                                },
                                {
                                    type: 'text',
                                    text: `Extract the data from this table image and format it as a tab-separated table.

Rules:
- Preserve all rows and columns exactly as shown
- Use tabs (\\t) to separate columns
- Include the header row if present
- Do not add any explanation or commentary
- Output ONLY the extracted table data
- Maintain numerical precision
- Keep column alignment

Example output format:
Player\\tWeek\\tOpponent\\tYards\\tAccuracy
Baker Mayfield\\t1\\t@ATL\\t167\\t53.1
Baker Mayfield\\t2\\t@HOU\\t215\\t65.8

Now extract the table:`
                                }
                            ]
                        }]
                    })
                });

                document.getElementById('ocrProgressBar').style.width = '80%';
                document.getElementById('ocrProgressText').textContent = 'Processing response...';

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Claude API error');
                }

                const data = await response.json();
                const extractedText = data.content?.[0]?.text || '';

                document.getElementById('ocrProgressBar').style.width = '100%';
                document.getElementById('ocrProgressText').textContent = 'OCR Complete!';
                document.getElementById('ocrText').value = extractedText;
                document.getElementById('ocrTextContainer').style.display = 'block';
                document.getElementById('parseOcrBtn').disabled = false;

                // Auto-detect delimiter
                const lines = smartSplitLines(extractedText);
                const delimiter = guessDelimiter(lines);
                document.getElementById('detectedDelimiter').textContent = delimiter.label;

                showOcrAlert('‚úÖ Successfully extracted table data using Claude!', 'success');

                setTimeout(() => {
                    document.getElementById('ocrProgressContainer').style.display = 'none';
                    document.getElementById('runOcrBtn').disabled = false;
                }, 2000);

            } catch (error) {
                console.error('OCR Error:', error);
                showOcrAlert('OCR Error: ' + (error.message || String(error)), 'error');
                document.getElementById('ocrProgressContainer').style.display = 'none';
                document.getElementById('runOcrBtn').disabled = false;
            }
        }

        // Parse OCR text to table
        function parseOcrText() {
            const text = document.getElementById('ocrText').value;
            if (!text.trim()) return;

            const parsed = parseTable(text);
            ocrTableData = parsed.rows;

            renderOcrTable();
            document.getElementById('ocrTableContainer').style.display = 'block';
            showOcrAlert(`Parsed ${parsed.rows.length} rows with ${parsed.modeCols} columns`, 'success');
        }

        // Render OCR table
        function renderOcrTable() {
            const hasHeader = document.getElementById('ocrHasHeader').checked;
            const thead = document.getElementById('ocrTableHead');
            const tbody = document.getElementById('ocrTableBody');

            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (ocrTableData.length === 0) return;

            // Header row
            const headerRow = document.createElement('tr');
            headerRow.style.background = 'var(--secondary-bg)';

            const headerData = hasHeader ? ocrTableData[0] : ocrTableData[0].map((_, i) => `Col ${i + 1}`);
            headerData.forEach((h, i) => {
                const th = document.createElement('th');
                th.style.padding = '0.75rem';
                th.style.textAlign = 'left';
                th.style.color = 'var(--accent)';

                if (hasHeader) {
                    const input = document.createElement('input');
                    input.value = h;
                    input.style.width = '100%';
                    input.style.background = 'transparent';
                    input.style.border = '1px solid var(--border)';
                    input.style.borderRadius = '4px';
                    input.style.padding = '0.5rem';
                    input.style.color = 'var(--text-primary)';
                    input.onchange = () => updateOcrCell(0, i, input.value);
                    th.appendChild(input);
                } else {
                    th.textContent = h;
                }

                headerRow.appendChild(th);
            });

            // Add delete column button
            const thActions = document.createElement('th');
            thActions.style.padding = '0.75rem';
            thActions.textContent = 'Actions';
            headerRow.appendChild(thActions);

            thead.appendChild(headerRow);

            // Data rows
            const startRow = hasHeader ? 1 : 0;
            for (let r = startRow; r < ocrTableData.length; r++) {
                const tr = document.createElement('tr');
                tr.style.background = r % 2 === 0 ? 'var(--secondary-bg)' : 'transparent';

                ocrTableData[r].forEach((cell, c) => {
                    const td = document.createElement('td');
                    td.style.padding = '0.5rem';

                    const input = document.createElement('input');
                    input.value = cell;
                    input.style.width = '100%';
                    input.style.background = 'transparent';
                    input.style.border = '1px solid var(--border)';
                    input.style.borderRadius = '4px';
                    input.style.padding = '0.5rem';
                    input.style.color = 'var(--text-primary)';
                    input.onchange = () => updateOcrCell(r, c, input.value);

                    td.appendChild(input);
                    tr.appendChild(td);
                });

                // Delete row button
                const tdActions = document.createElement('td');
                tdActions.style.padding = '0.5rem';
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Remove';
                deleteBtn.className = 'btn btn-small btn-secondary';
                deleteBtn.onclick = () => ocrRemoveRow(r);
                tdActions.appendChild(deleteBtn);
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            }
        }

        function updateOcrCell(row, col, value) {
            if (ocrTableData[row]) {
                ocrTableData[row][col] = value;
            }
        }

        function ocrAddRow() {
            if (ocrTableData.length === 0) return;
            const cols = ocrTableData[0].length;
            ocrTableData.push(Array(cols).fill(''));
            renderOcrTable();
        }

        function ocrAddColumn() {
            if (ocrTableData.length === 0) {
                ocrTableData.push(['']);
            } else {
                ocrTableData.forEach(row => row.push(''));
            }
            renderOcrTable();
        }

        function ocrRemoveRow(index) {
            ocrTableData.splice(index, 1);
            renderOcrTable();
        }

        // Download CSV
        function downloadOcrCSV() {
            if (ocrTableData.length === 0) return;

            const hasHeader = document.getElementById('ocrHasHeader').checked;
            const rows = hasHeader ? ocrTableData :
                [[...Array(ocrTableData[0].length).keys()].map(i => `Col ${i + 1}`), ...ocrTableData];

            const csv = rowsToCSV(rows);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'qb_stats_ocr.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            showOcrAlert('CSV downloaded successfully!', 'success');
        }

        // Upload to Supabase
        async function uploadOcrDataToSupabase() {
            if (ocrTableData.length === 0) {
                showOcrAlert('No data to upload', 'error');
                return;
            }

            const hasHeader = document.getElementById('ocrHasHeader').checked;
            const headers = hasHeader ? ocrTableData[0] :
                ['player', 'week', 'opponent', 'passing_yards', 'accuracy_pct', 'comp_pct', 'btt_rate', 'twp_rate', 'prop_line', 'bet_result'];

            const dataRows = hasHeader ? ocrTableData.slice(1) : ocrTableData;

            // Convert to objects
            const records = dataRows.map(row => {
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = row[i] || null;
                });
                return obj;
            });

            // Format for Supabase
            const formattedData = records.map(row => ({
                player: row.player || row.Player || '',
                week: parseInt(row.week || row.Week) || 0,
                opponent: row.opponent || row.Opponent || '',
                passing_yards: parseInt(row.passing_yards || row['Passing Yards'] || row.Yards) || 0,
                accuracy_pct: parseFloat(row.accuracy_pct || row['Accuracy %'] || row.Accuracy) || 0,
                comp_pct: parseFloat(row.comp_pct || row['Comp %'] || row.Completion) || 0,
                btt_rate: parseFloat(row.btt_rate || row['BTT Rate'] || row.BTT) || 0,
                twp_rate: parseFloat(row.twp_rate || row['TWP Rate'] || row.TWP) || 0,
                prop_line: row.prop_line ? parseFloat(row.prop_line) : null,
                bet_result: row.bet_result || row['Bet Result'] || null
            }));

            try {
                const { error } = await SupabaseDB.bulkInsertCSV(formattedData);

                if (error) {
                    showOcrAlert('Upload error: ' + error.message, 'error');
                    return;
                }

                showOcrAlert(`Successfully uploaded ${formattedData.length} records!`, 'success');

                // Refresh main data table
                await loadData();

                // Switch to data management tab
                setTimeout(() => {
                    switchTab('data-management');
                }, 2000);
            } catch (err) {
                showOcrAlert('Upload error: ' + String(err?.message || err), 'error');
            }
        }

        function showOcrAlert(message, type) {
            const alertBox = document.getElementById('ocrAlertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => alertBox.className = 'alert', 5000);
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
